<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RING THE BELL</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Courier New', Courier, monospace; touch-action: manipulation; }
        canvas { display: block; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: space-between; align-items: center; padding: 20px;
            box-sizing: border-box; z-index: 10;
        }

        #warning-text {
            color: #ff0000; font-size: 2rem; font-weight: bold; text-align: center;
            text-transform: uppercase; opacity: 0; transition: opacity 0.1s;
        }

        #santa-msg {
            color: white; font-size: 1.2rem; background: rgba(0,0,0,0.7);
            padding: 10px; border-radius: 5px; text-align: center; max-width: 80%;
        }

        .shake { animation: shake 0.1s infinite; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            50% { transform: translate(-1px, -2px) rotate(-1deg); }
            100% { transform: translate(1px, -1px) rotate(1deg); }
        }

        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); color: gold; display: flex;
            justify-content: center; align-items: center; z-index: 100;
            text-align: center; font-size: 1.5rem; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="overlay"><h1>TAP TO START THE CARNAGE ðŸ””</h1></div>

<div id="ui-layer">
    <div id="warning-text">STOP IT</div>
    <div id="santa-msg">Ho ho ho! Ring the bell, child!</div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    let scene, camera, renderer, bell, particles, analyzer, dataArray;
    let chaosLevel = 0;
    let isExploded = false;
    const messages = [
        "Ho ho ho! Ring it!", "That's a nice sound.", "Okay, plenty of joy now.",
        "STOP RINGING.", "SANTA HAS A HEADACHE.", "MY EARS ARE BLEEDING.",
        "THE REINDEER ARE BOLTING.", "I'M CANCELLING CHRISTMAS.",
        "YOU FOOL. YOU'VE BROKEN THE VOID.", "SANTA IS NOT OK.", "ABANDON ALL HOPE."
    ];

    // Setup
    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // Lighting
        const light = new THREE.PointLight(0xff0000, 10, 100);
        light.position.set(5, 5, 5);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040, 2));

        // The Bell
        const geometry = new THREE.CylinderGeometry(0.5, 1.5, 2, 32);
        const material = new THREE.MeshPhongMaterial({ 
            color: 0xffd700, 
            shininess: 100, 
            flatShading: false,
            emissive: 0x221100 
        });
        bell = new THREE.Mesh(geometry, material);
        scene.add(bell);

        // Particle System (Snow/Shards)
        const pGeo = new THREE.BufferGeometry();
        const pCount = 1000;
        const posArr = new Float32Array(pCount * 3);
        for(let i=0; i<pCount*3; i++) posArr[i] = (Math.random() - 0.5) * 10;
        pGeo.setAttribute('position', new THREE.BufferAttribute(posArr, 3));
        const pMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.05 });
        particles = new THREE.Points(pGeo, pMat);
        scene.add(particles);

        window.addEventListener('resize', onWindowResize);
        window.addEventListener('touchstart', (e) => { e.preventDefault(); ring(); }, {passive: false});
        window.addEventListener('click', ring);
    }

    async function initAudio() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(stream);
        analyzer = audioCtx.createAnalyser();
        analyzer.fftSize = 256;
        source.connect(analyzer);
        dataArray = new Uint8Array(analyzer.frequencyBinCount);
    }

    function ring() {
        if (chaosLevel > 100) return; // Final Freeze
        
        chaosLevel += 1;
        
        // Visual feedback
        bell.scale.multiplyScalar(1.05);
        bell.material.color.setHSL(0.1, 1, 0.5 - (chaosLevel / 200));
        
        // Randomize geometry (Glitch effect)
        const pos = bell.geometry.attributes.position;
        for(let i=0; i<pos.count; i++) {
            pos.setZ(i, pos.getZ(i) + (Math.random() - 0.5) * (chaosLevel/50));
        }
        pos.needsUpdate = true;

        // UI Chaos
        updateUI();

        // Sound Simulation (Visual only if no audio assets provided)
        document.body.style.backgroundColor = (chaosLevel % 2 === 0) ? "#300" : "#000";
    }

    function updateUI() {
        const msgIndex = Math.min(Math.floor(chaosLevel / 10), messages.length - 1);
        const msgEl = document.getElementById('santa-msg');
        const warnEl = document.getElementById('warning-text');
        
        msgEl.innerText = messages[msgIndex];
        msgEl.style.transform = `translate(${(Math.random()-0.5)*chaosLevel}px, ${(Math.random()-0.5)*chaosLevel}px)`;
        
        if (chaosLevel > 30) {
            warnEl.style.opacity = 1;
            warnEl.innerText = chaosLevel > 80 ? "REALITY COLLAPSING" : "STOP RINGING";
            document.getElementById('ui-layer').classList.add('shake');
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        
        let micBoost = 0;
        if (analyzer) {
            analyzer.getByteFrequencyData(dataArray);
            micBoost = dataArray.reduce((a, b) => a + b) / dataArray.length;
            if (micBoost > 50) ring(); // Shout to ring
        }

        const intensity = (chaosLevel / 100) + (micBoost / 255);
        
        // Bell rotation & shake
        bell.rotation.y += 0.01 + intensity * 0.5;
        bell.rotation.z = Math.sin(Date.now() * 0.01) * intensity;
        
        // Camera instability
        camera.position.x = Math.sin(Date.now() * 0.05) * intensity;
        camera.position.y = Math.cos(Date.now() * 0.05) * intensity;
        camera.zoom = 1 + (Math.sin(Date.now() * 0.1) * intensity * 0.5);
        camera.updateProjectionMatrix();

        // Explosion check
        if (chaosLevel > 90 && !isExploded) {
            bell.material.wireframe = true;
            particles.scale.multiplyScalar(1.1);
        }

        if (chaosLevel >= 110) {
            document.getElementById('santa-msg').innerText = "SANTA HAS HAD ENOUGH.";
            document.body.style.filter = "invert(1) contrast(200%)";
            return; // Freeze app
        }

        renderer.render(scene, camera);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    document.getElementById('overlay').addEventListener('click', () => {
        document.getElementById('overlay').style.display = 'none';
        init();
        initAudio().catch(() => console.log("Mic blocked"));
        animate();
    });

</script>
</body>
</html>
